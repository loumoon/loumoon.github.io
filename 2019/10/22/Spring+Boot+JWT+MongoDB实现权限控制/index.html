<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Spring Boot+JWT+MongoDB实现权限控制"><meta name="keywords" content="Java,Spring Boot,Web,Token,登录,JWT,MongoDB,权限控制"><meta name="author" content="Moon Lou"><meta name="copyright" content="Moon Lou"><title>Spring Boot+JWT+MongoDB实现权限控制 | Moon's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、JWT"><span class="toc-text">一、JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-什么是JWT"><span class="toc-text">1.什么是JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JWT请求与响应流程"><span class="toc-text">2.JWT请求与响应流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-JWT的结构"><span class="toc-text">3.JWT的结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、项目权限控制功能的实现"><span class="toc-text">二、项目权限控制功能的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-pom-xml文件配置依赖"><span class="toc-text">1.pom.xml文件配置依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Spring-Boot配置文件application-properties"><span class="toc-text">2.Spring Boot配置文件application.properties</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-实体类User-java"><span class="toc-text">3.实体类User.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-持久化数据层UserRepository-java"><span class="toc-text">4.持久化数据层UserRepository.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-JWT工具类JWTUtil-java"><span class="toc-text">5.JWT工具类JWTUtil.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-业务逻辑层UserService-java"><span class="toc-text">6.业务逻辑层UserService.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-定义用户角色Role-java"><span class="toc-text">7.定义用户角色Role.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-为每种角色定义权限注解"><span class="toc-text">8.为每种角色定义权限注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-控制器UserController-java"><span class="toc-text">9.控制器UserController.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-定义一些DTO类"><span class="toc-text">10.定义一些DTO类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-拦截器JWTInterceptor-java"><span class="toc-text">11.拦截器JWTInterceptor.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-响应实体类Result-java"><span class="toc-text">12.响应实体类Result.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-状态码枚举类RespStatus-java"><span class="toc-text">13.状态码枚举类RespStatus.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-响应工具类ResultUtil-java"><span class="toc-text">14.响应工具类ResultUtil.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-自定义异常类型"><span class="toc-text">15.自定义异常类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-全局异常处理类GlobalExceptionHandler-java"><span class="toc-text">16.全局异常处理类GlobalExceptionHandler.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、效果演示"><span class="toc-text">三、效果演示</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Moon Lou</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/loumoon">关注我</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">36</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">39</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">11</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friend Links</div><a class="author-info-links__name text-center" href="https://elody-07.github.io">Elody</a><a class="author-info-links__name text-center" href="http://gaocegege.com/Blog/">高策哥哥</a><a class="author-info-links__name text-center" href="https://molunerfinn.com">MARKSZ</a><a class="author-info-links__name text-center" href="https://sheey.moe">Sheey</a><a class="author-info-links__name text-center" href="https://huangxuan.me/">黄玄</a><a class="author-info-links__name text-center" href="https://blog.azard.me">熊伟伦</a><a class="author-info-links__name text-center" href="https://blindingend.github.io/">Blinding</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Moon's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span></div><div id="post-info"><div id="post-title">Spring Boot+JWT+MongoDB实现权限控制</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">3.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 15 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>沈阿姨的课程项目，<a href="http://ist.sjtu.edu.cn" target="_blank" rel="noopener">IST实验室</a>五个研一的同学组队，实现一个基于微服务的工业流程管理平台。在sprint1中我负责平台的权限控制功能，这里记录一下思路和代码实现过程。</p>
</blockquote>
<a id="more"></a>

<ul>
<li><strong>用JWT进行权限控制是基于Token的会话管理思想，参考我另一篇<a href="https://loumoon.github.io/2019/10/25/Web开发中会话管理的三种方式/">介绍会话管理的博客</a>。</strong></li>
</ul>
<h2 id="一、JWT"><a href="#一、JWT" class="headerlink" title="一、JWT"></a>一、JWT</h2><h3 id="1-什么是JWT"><a href="#1-什么是JWT" class="headerlink" title="1.什么是JWT"></a>1.什么是JWT</h3><p>JSON Web Token（JWT），是为了在网络应用环境间传递声明而执行的一种基于JSON的开放<strong>标准</strong>。定义了一种简洁的、自包含的方法用于通信双方之间以JSON对象的形式安全地传递信息，<strong>数字签名的存在可以保证这些信息是可信的，没有经过伪造的</strong>。</p>
<h3 id="2-JWT请求与响应流程"><a href="#2-JWT请求与响应流程" class="headerlink" title="2.JWT请求与响应流程"></a>2.JWT请求与响应流程</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8afmwyigyj30pm0dhdgp.jpg" alt></p>
<p>（1）用户使用账号和密码，通过POST请求访问登录API接口，进行登录</p>
<p>（2）服务端登录验证成功，根据密钥生成一个JWT</p>
<p>（3）服务端将生成的JWT返回给浏览器</p>
<p>（4）浏览器下次像服务端发送请求，需要将JWT放在请求头中</p>
<p>（5）服务端检查请求头中的JWT，通过签名算法和密钥验证其合法性，并从中解码用户信息</p>
<p>（6）返回响应给浏览器</p>
<h3 id="3-JWT的结构"><a href="#3-JWT的结构" class="headerlink" title="3.JWT的结构"></a>3.JWT的结构</h3><p>JWT包含三部分：</p>
<ul>
<li>Header：头部，包含token类型和加密算法</li>
<li>Payload：负载，存放有效信息</li>
<li>Signature：签名/签证，标识JWT的合法性</li>
</ul>
<p>（1）Header头部是一个包含了两个部分的JSON对象：签名使用的算法（通常是HS256或者RSA）和token类型（JWT）：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）Payload负载也是一个JSON对象，官方提供了一些不强制使用的字段:</p>
<ul>
<li>iss (issuer): jwt签发者</li>
<li>sub (subject): 面向的用户(jwt所面向的用户)</li>
<li>aud (audience): 接收jwt的一方</li>
<li>exp (expiration time): 过期时间戳(jwt的过期时间，这个过期时间必须要大于签发时间)</li>
<li>nbf (not before): 定义在什么时间之前，该jwt都是不可用的</li>
<li>iat (issued at): jwt的签发时间</li>
<li>jti (jwt id): jwt的唯一身份标识，主要用来作为一次性<code>token</code>,从而回避重放攻击</li>
</ul>
<p>当然除了以上之外也可以自定义字段，Payload示例：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="attr">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）Signature密钥是对前两部分的签名，标识JWT的合法性。首先要制定一个仅服务器可见的密钥（secret），然后使用Header里指定的签名算法（HS256）按照下面公式生成签名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>

<p>算出签名后把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”.”分隔，就产生了最终的JWT，返回给用户。</p>
<h2 id="二、项目权限控制功能的实现"><a href="#二、项目权限控制功能的实现" class="headerlink" title="二、项目权限控制功能的实现"></a>二、项目权限控制功能的实现</h2><blockquote>
<p>先贴上项目的源代码地址：<a href="https://github.com/loumoon/Sping-Boot-Mongodb-JWT" target="_blank" rel="noopener">Sping-Boot-Mongodb-JWT</a></p>
</blockquote>
<h3 id="1-pom-xml文件配置依赖"><a href="#1-pom-xml文件配置依赖" class="headerlink" title="1.pom.xml文件配置依赖"></a>1.pom.xml文件配置依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.edu.sjtu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>industry_backend<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>industry_backend<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.58<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Spring-Boot配置文件application-properties"><a href="#2-Spring-Boot配置文件application-properties" class="headerlink" title="2.Spring Boot配置文件application.properties"></a>2.Spring Boot配置文件application.properties</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.data.mongodb.host = localhost</span><br><span class="line">spring.data.mongodb.port = 27017</span><br><span class="line">spring.data.mongodb.database = industry</span><br><span class="line">server.port = 8080</span><br></pre></td></tr></table></figure>

<p>项目要连接本地MongoDB，数据库名称为’industry’。</p>
<h3 id="3-实体类User-java"><a href="#3-实体类User-java" class="headerlink" title="3.实体类User.java"></a>3.实体类User.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId; <span class="comment">// 工号</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer role;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tolerate</span></span><br><span class="line">    User() &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实体类对应MongoDB数据库中的’user’表。用户使用工号userId和密码password登录，id属性是向MongoDB插入数据会自动生成的字段，在业务逻辑中一般不使用。</p>
<h3 id="4-持久化数据层UserRepository-java"><a href="#4-持久化数据层UserRepository-java" class="headerlink" title="4.持久化数据层UserRepository.java"></a>4.持久化数据层UserRepository.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">User</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">User <span class="title">findUserByUserId</span><span class="params">(<span class="keyword">final</span> String userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要继承MongoRepository接口即可，太好用了叭！</p>
<h3 id="5-JWT工具类JWTUtil-java"><a href="#5-JWT工具类JWTUtil-java" class="headerlink" title="5.JWT工具类JWTUtil.java"></a>5.JWT工具类JWTUtil.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(JWTConstant.SECRET_KEY);</span><br><span class="line">        <span class="keyword">return</span> JWT.create()</span><br><span class="line">                .withExpiresAt(<span class="keyword">new</span> Date(System.currentTimeMillis() + JWTConstant.VALIDITY_PERIOD))</span><br><span class="line">                .withAudience(user.getUserId())</span><br><span class="line">                .withClaim(<span class="string">"role"</span>, user.getRole())</span><br><span class="line">                .sign(algorithm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decodeUserId</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JWT.decode(token).getAudience().get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">decodeRole</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JWT.decode(token).getClaim(<span class="string">"role"</span>).asInt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC256(JWTConstant.SECRET_KEY)).build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jwtVerifier.verify(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JWTVerificationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.INVALID_TOKEN);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JWT生成、验证、解码的逻辑写在了一个工具类中。生成JWT时，将用户的userId和<strong>角色role</strong>塞了进去，方便对后面请求进行权限验证，不需要再访问数据库查用户权限了。</p>
<h3 id="6-业务逻辑层UserService-java"><a href="#6-业务逻辑层UserService-java" class="headerlink" title="6.业务逻辑层UserService.java"></a>6.业务逻辑层UserService.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">signIn</span><span class="params">(String userId, String password)</span> </span>&#123;</span><br><span class="line">        User user = findUserById(userId);</span><br><span class="line">        <span class="keyword">if</span>(!user.getPassword().equals(password)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(RespStatus.WRONG_PASSWORD, <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            String token = JWTUtil.encode(user);</span><br><span class="line">            <span class="keyword">return</span> token;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signUp</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(userRepository.findUserByUserId(user.getUserId()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(RespStatus.EXIST_ACCOUNT, <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        User user = userRepository.findUserByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(RespStatus.NON_ACCOUNT, <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录注册的业务逻辑实现。如果登录成功，会生成一个JWT返回给用户。</p>
<h3 id="7-定义用户角色Role-java"><a href="#7-定义用户角色Role-java" class="headerlink" title="7.定义用户角色Role.java"></a>7.定义用户角色Role.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Role &#123;</span><br><span class="line">    MAINTAINER,</span><br><span class="line">    MANAGER,</span><br><span class="line">    PROCESSOR,</span><br><span class="line">    OPERATOR</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>系统中一共有四种角色，定义一个枚举类。</p>
<h3 id="8-为每种角色定义权限注解"><a href="#8-为每种角色定义权限注解" class="headerlink" title="8.为每种角色定义权限注解"></a>8.为每种角色定义权限注解</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MaintainerToken &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每种角色都对应一个权限注解，这些注解标注在Controller中的handler上，表示该handler有哪些角色具有请求权限。以上是Maintainer的权限注解@MaintainerToken，另外三个同上分别是@ManagerToken、@ProcessorToken、@OperatorToken。除此之外，还有第五个@PassToken，这个是通用注解，它标识的handler任何请求都可以访问，不需要权限验证。</p>
<h3 id="9-控制器UserController-java"><a href="#9-控制器UserController-java" class="headerlink" title="9.控制器UserController.java"></a>9.控制器UserController.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Mapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PassToken</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/signIn"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">signIn</span><span class="params">(@RequestBody SignInDTO signInDTO)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String userId = signInDTO.getUserId();</span><br><span class="line">        String password = signInDTO.getPassword();</span><br><span class="line">        String token = userService.signIn(userId, password);</span><br><span class="line">        TokenDTO tokenDTO = TokenDTO.builder().token(token).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResultUtil.success(tokenDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PassToken</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/signUp"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">signUp</span><span class="params">(@RequestBody UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        User user = mapper.map(userDTO, User.class);</span><br><span class="line">        userService.signUp(user);</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*测试，只有运维人员和管理人员有权限访问的服务*/</span></span><br><span class="line">    <span class="meta">@MaintainerToken</span></span><br><span class="line">    <span class="meta">@ManagerToken</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/test"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">test</span><span class="params">(@RequestHeader(<span class="string">"token"</span>)</span> String token) </span>&#123;</span><br><span class="line">        String userId = JWTUtil.decodeUserId(token);</span><br><span class="line">        User user = userService.findUserById(userId);</span><br><span class="line">        UserDTO userDTO = mapper.map(user, UserDTO.class);</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如图，每个handler哪些角色有权限访问，全部通过自定义的权限注解来实现。比如登录和注册handler有@PassToken注解，说明任何请求都可以访问它，不需要权限验证。测试handler有注解@MaintainerToken和@ManagerToken，说明只有Maintainer和Manager有权限访问它。</p>
<h3 id="10-定义一些DTO类"><a href="#10-定义一些DTO类" class="headerlink" title="10.定义一些DTO类"></a>10.定义一些DTO类</h3><p>可以看到控制器中的传输参数用的是DTO类，里面封装了和客户端进行传输的数据类型。使用Dozer进行实体类和DTO类之间的映射，从而方便地进行实体类和DTO类的相互转换。</p>
<h3 id="11-拦截器JWTInterceptor-java"><a href="#11-拦截器JWTInterceptor-java" class="headerlink" title="11.拦截器JWTInterceptor.java"></a>11.拦截器JWTInterceptor.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HandlerMethod handlerMethod = (HandlerMethod) handler;</span><br><span class="line">        Method method = handlerMethod.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异常发生后ErrorController的/error</span></span><br><span class="line">        <span class="keyword">if</span>(method.getName().equals(<span class="string">"error"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有免验证令牌的handler</span></span><br><span class="line">        <span class="keyword">if</span>(method.isAnnotationPresent(PassToken.class)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 检查token是否存在</span></span><br><span class="line">            String token = request.getHeader(<span class="string">"token"</span>);</span><br><span class="line">            <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.NON_TOKEN);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 验证token是否合法</span></span><br><span class="line">            JWTUtil.verify(token);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查用户权限</span></span><br><span class="line">            Integer role = JWTUtil.decodeRole(token);</span><br><span class="line">            <span class="keyword">if</span>(role.equals(Role.MAINTAINER.ordinal())) &#123;</span><br><span class="line">                <span class="keyword">if</span>(method.isAnnotationPresent(MaintainerToken.class)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.NON_AUTHORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(role.equals(Role.MANAGER.ordinal())) &#123;</span><br><span class="line">                <span class="keyword">if</span>(method.isAnnotationPresent(ManagerToken.class)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.NON_AUTHORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(role.equals(Role.PROCESSOR.ordinal())) &#123;</span><br><span class="line">                <span class="keyword">if</span>(method.isAnnotationPresent(ProcessorToken.class)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.NON_AUTHORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(role.equals(Role.OPERATOR.ordinal())) &#123;</span><br><span class="line">                <span class="keyword">if</span>(method.isAnnotationPresent(OperatorToken.class)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.NON_AUTHORITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(RespStatus.INVALID_TOKEN);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                           HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Object handler, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个拦截器是实现权限控制的核心模块。客户端过来的所有请求，会先被拦截器拦截下来，从这个请求头中拿出JWT，验证其合法性，并解码JWT中的用户权限字段role，然后比照role和所请求的handler的权限注解，如果符合权限要求，就释放这个请求到Controller层去处理，否则抛异常拦截掉这个请求。</p>
<h3 id="12-响应实体类Result-java"><a href="#12-响应实体类Result-java" class="headerlink" title="12.响应实体类Result.java"></a>12.响应实体类Result.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** 状态码 */</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 错误信息 */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 返回数据 */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了保证响应给前端的数据格式都具有统一的标准，定义响应实体类，由状态码、错误信息、数据三部分组成。</p>
<h3 id="13-状态码枚举类RespStatus-java"><a href="#13-状态码枚举类RespStatus-java" class="headerlink" title="13.状态码枚举类RespStatus.java"></a>13.状态码枚举类RespStatus.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> RespStatus &#123;</span><br><span class="line">    SUCCESS(<span class="string">"200"</span>, <span class="string">"请求成功"</span>),</span><br><span class="line"></span><br><span class="line">    NON_AUTHORITY(<span class="string">"300"</span>, <span class="string">"不具备请求权限"</span>),</span><br><span class="line">    INVALID_TOKEN(<span class="string">"301"</span>, <span class="string">"令牌不合法"</span>),</span><br><span class="line">    NON_TOKEN(<span class="string">"302"</span>, <span class="string">"令牌不存在"</span>),</span><br><span class="line">    WRONG_PASSWORD(<span class="string">"303"</span>, <span class="string">"密码错误"</span>),</span><br><span class="line">    NON_ACCOUNT(<span class="string">"304"</span>, <span class="string">"账户不存在"</span>),</span><br><span class="line">    EXIST_ACCOUNT(<span class="string">"305"</span>, <span class="string">"账号已存在"</span>),</span><br><span class="line"></span><br><span class="line">    SERVER_ERROR(<span class="string">"400"</span>, <span class="string">"服务器错误"</span>),</span><br><span class="line"></span><br><span class="line">    UNKNOWN_ERROR(<span class="string">"500"</span>, <span class="string">"未知错误"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    RespStatus(String code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对响应实体类Result中的属性status和message，枚举类RespStatus定义了规范，根据响应状态，每个响应体对象都会与某个RespStatus对象绑定。</p>
<h3 id="14-响应工具类ResultUtil-java"><a href="#14-响应工具类ResultUtil-java" class="headerlink" title="14.响应工具类ResultUtil.java"></a>14.响应工具类ResultUtil.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">success</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.setStatus(RespStatus.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(RespStatus.SUCCESS.getMessage());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">error</span><span class="params">(RespStatus status)</span> </span>&#123;</span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.setStatus(status.getCode());</span><br><span class="line">        result.setMessage(status.getMessage());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为对于不同的响应情况，响应实体的构建是不一样的，为了避免在响应实体类Result中实现繁复的构造方法，实现一个响应工具类，根据具体情况快速构造响应体。可以看到，对于每个响应体对象的构建方法，某个RespStatus对象都会作为必要的输入参数。</p>
<h3 id="15-自定义异常类型"><a href="#15-自定义异常类型" class="headerlink" title="15.自定义异常类型"></a>15.自定义异常类型</h3><p>自定义了两个异常类型：AuthorityException&amp;&amp;ServiceException</p>
<p>（1）首先看AuthorityException.java:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="meta">@Setter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorityException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RespStatus status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuthorityException</span><span class="params">(RespStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入了枚举对象RespStatus，说明每个AuthorityException对象都与一个特定的状态码枚举对象RespStatus绑定，标识这个异常发生后对应的响应状态。</p>
<p>AuthorityException全部在权限拦截器JWTInterceptor中抛出。</p>
<p>（2）再看ServiceException：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="meta">@Setter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String service; <span class="comment">// 发生异常的Service</span></span><br><span class="line">    <span class="keyword">private</span> RespStatus status; <span class="comment">// 异常状态码</span></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceException</span><span class="params">(RespStatus status, String service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与AuthorityException相同，也注入了枚举对象RespStatus。除此之外，还注入了一个String类型的service，用来标识该异常是在哪个Service中抛出的。</p>
<p>ServiceException全部在Service层抛出。</p>
<h3 id="16-全局异常处理类GlobalExceptionHandler-java"><a href="#16-全局异常处理类GlobalExceptionHandler-java" class="headerlink" title="16.全局异常处理类GlobalExceptionHandler.java"></a>16.全局异常处理类GlobalExceptionHandler.java</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(GlobalExceptionHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(MongoException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handleMongoException</span><span class="params">(<span class="keyword">final</span> MongoException exception)</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"Processing MongoException: &#123;&#125;"</span>, exception.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.error(RespStatus.SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(AuthorityException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handleAuthorityException</span><span class="params">(<span class="keyword">final</span> AuthorityException exception)</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"Processing  AuthorityException: &#123;&#125;"</span>, exception.getStatus().getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.error(exception.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ServiceException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handleServiceException</span><span class="params">(<span class="keyword">final</span> ServiceException exception)</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"Processing  ServiceException at "</span> + exception.getService() + <span class="string">": &#123;&#125;"</span>, exception.getStatus().getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.error(exception.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了避免在Controller层定义一堆的try……catch块来捕捉Service层抛出的异常，将异常处理和业务逻辑过程解耦，定义一个全局异常处理类。它不仅能捕获Service层抛出的异常，也能捕获权限拦截器JWTInterceptor抛出的异常，并对捕获的异常进行处理。</p>
<p><strong>一个坑：</strong>注意@ResponseBody这个注解一定要存在，表示每个handler的返回值是直接写到响应体中的，然后返回给客户端。如果没有这个注解，任何异常发生后，spring boot会自发一个’/error’的请求，映射到默认错误处理类ErrorController的’/error’对应的handler，这个默认方法会进行处理然后返回给客户端一个原生的响应体，覆盖掉我们自己在GlobalExceptionHandler里自定义构建的响应体。这个原生的响应体如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-30T07:53:11.228+0000"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">    <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">    <span class="attr">"path"</span>: <span class="string">"/user/test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此一定要使用@ResponseBody注解，将异常发生后的返回值直接写入响应体返回给客户端，spring boot就来不及自发这个’/error’请求了。</p>
<h2 id="三、效果演示"><a href="#三、效果演示" class="headerlink" title="三、效果演示"></a>三、效果演示</h2><p>前后端是RESTful的交互方式，因此使用Postman工具进行效果演示。</p>
<p>首先，注册一个用户：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gbae6xe1j31e80u0td0.jpg" alt></p>
<p>检查MongoDB的情况：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gaqlogkxj31ao0skgyh.jpg" alt></p>
<p>注册成功，现在用这个账户进行登录：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8garhvmdaj31e80u04kw.jpg" alt></p>
<p>登录成功后端返回了一串token，下次请求将这个token放在请求头中，注意/user/test接口的请求方法是GET：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gawnv3xwj31e80u0aut.jpg" alt></p>
<p>可以看到，用户的角色role为3，对应Role.OPERATOR，而/user/test接口上的注解是@MaintainerToken和@ManagerToken，说明只有Maintainer和Manager具有访问权限，而该用户权限不够。</p>
<p>重新注册一个role为1，对应Role.MANAGER的用户，登录后，请求/user/test接口：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gb3pf3nfj31e80u0wym.jpg" alt></p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gb4dlp5cj31e80u0qpk.jpg" alt></p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gb5ds222j31e80u04lf.jpg" alt></p>
<p>可以看到，这个用户具有访问接口/user/test的权限，请求成功。</p>
<p>把token的第一个字符’e’删掉，再发送请求，后端返回令牌不合法的错误响应：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gb7d3aiij31e80u04hm.jpg" alt></p>
<p>不带token，再发送请求，后端返回令牌不存在的错误响应：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g8gb8yzzk6j31e80u0qm0.jpg" alt></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Moon Lou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://loumoon.github.io/2019/10/22/Spring+Boot+JWT+MongoDB实现权限控制/">https://loumoon.github.io/2019/10/22/Spring+Boot+JWT+MongoDB实现权限控制/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://loumoon.github.io">Moon's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/Token/">Token</a><a class="post-meta__tags" href="/tags/登录/">登录</a><a class="post-meta__tags" href="/tags/JWT/">JWT</a><a class="post-meta__tags" href="/tags/MongoDB/">MongoDB</a><a class="post-meta__tags" href="/tags/权限控制/">权限控制</a></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/10/25/MacBook上Spring Boot启动慢的问题/"><i class="fa fa-chevron-left">  </i><span>MacBook上Spring Boot启动慢的问题</span></a></div><div class="next-post pull-right"><a href="/2019/10/16/Hexo框架+Melody主题的个人博客使用记录/"><span>Hexo框架+Melody主题的个人博客使用记录</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'f63ebded7787ca87f4f9',
  clientSecret: 'e76d99c38cbb4edca3712ea17decab5581ec0b14',
  repo: 'loumoon.github.io',
  owner: 'loumoon',
  admin: 'loumoon',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/top.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By Moon Lou</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://loumoon.github.io/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>